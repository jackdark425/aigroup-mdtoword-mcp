# é¡¹ç›®åŠŸèƒ½ä¼˜åŒ–æ€»ç»“

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†é¡¹ç›®çš„æ‰€æœ‰åŠŸèƒ½å¢å¼ºå’Œä¼˜åŒ–æ”¹è¿›ã€‚

## ğŸ“‹ ç›®å½•

1. [æ–°å¢åŠŸèƒ½](#æ–°å¢åŠŸèƒ½)
2. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
3. [ä»£ç è´¨é‡æ”¹è¿›](#ä»£ç è´¨é‡æ”¹è¿›)
4. [ç”¨æˆ·ä½“éªŒæ”¹è¿›](#ç”¨æˆ·ä½“éªŒæ”¹è¿›)
5. [æŠ€æœ¯ç»†èŠ‚](#æŠ€æœ¯ç»†èŠ‚)

---

## ğŸ¯ æ–°å¢åŠŸèƒ½

### 1. ä¸»é¢˜ç³»ç»Ÿï¼ˆTheme Systemï¼‰

**ä½ç½®**: `src/types/style.ts`, `src/utils/styleEngine.ts`

**åŠŸèƒ½æè¿°**:
- ç»Ÿä¸€ç®¡ç†æ–‡æ¡£é¢œè‰²ã€å­—ä½“å’Œé—´è·
- æ”¯æŒä¸»é¢˜ç»§æ‰¿å’Œå˜é‡
- è‡ªåŠ¨åº”ç”¨ä¸»é¢˜åˆ°å„ç§æ ·å¼å…ƒç´ 

**å®ç°ç»†èŠ‚**:
```typescript
interface ThemeConfig {
  name: string;
  colors?: {
    primary?: string;
    secondary?: string;
    // ... è‡ªå®šä¹‰é¢œè‰²
  };
  fonts?: {
    heading?: string;
    body?: string;
    code?: string;
  };
  spacing?: {
    small?: number;
    medium?: number;
    large?: number;
  };
}
```

**ä½¿ç”¨ç¤ºä¾‹**:
```json
{
  "theme": {
    "name": "ä¸“ä¸šè“è‰²ä¸»é¢˜",
    "colors": { "primary": "2E5C8A" },
    "fonts": { "heading": "å¾®è½¯é›…é»‘" }
  }
}
```

### 2. æ°´å°åŠŸèƒ½ï¼ˆWatermarkï¼‰

**ä½ç½®**: `src/types/style.ts`, `src/utils/watermarkProcessor.ts`

**åŠŸèƒ½æè¿°**:
- æ·»åŠ æ–‡æ¡£æ°´å°
- æ”¯æŒè‡ªå®šä¹‰æ–‡æœ¬ã€å­—ä½“ã€é¢œè‰²
- å¯é…ç½®é€æ˜åº¦å’Œæ—‹è½¬è§’åº¦

**å®ç°ç»†èŠ‚**:
- ä½¿ç”¨docxåº“çš„æ°´å°åŠŸèƒ½
- æä¾›é…ç½®éªŒè¯å’Œé»˜è®¤å€¼
- æ”¯æŒå¯¹è§’çº¿ã€æ°´å¹³ã€å‚ç›´ç­‰ä½ç½®

**é…ç½®ç¤ºä¾‹**:
```json
{
  "watermark": {
    "text": "æœºå¯†æ–‡æ¡£",
    "opacity": 0.2,
    "rotation": -45
  }
}
```

### 3. é¡µçœ‰é¡µè„šï¼ˆHeader/Footerï¼‰

**ä½ç½®**: `src/types/style.ts`, `src/converter/markdown.ts`

**åŠŸèƒ½æè¿°**:
- è‡ªå®šä¹‰é¡µçœ‰å’Œé¡µè„šå†…å®¹
- è‡ªåŠ¨é¡µç æ”¯æŒ
- å¯é…ç½®æ–‡å­—æ ·å¼å’Œè¾¹æ¡†
- æ”¯æŒé¦–é¡µ/å¥‡å¶é¡µå·®å¼‚

**å®ç°ç»†èŠ‚**:
- é›†æˆåˆ°æ–‡æ¡£èŠ‚é…ç½®ä¸­
- ä½¿ç”¨docxçš„Headerå’ŒFooterç±»
- æ”¯æŒPageNumberç»„ä»¶

**é…ç½®ç¤ºä¾‹**:
```json
{
  "headerFooter": {
    "header": { "content": "ä¼ä¸šæ–‡æ¡£" },
    "footer": {
      "content": "ç¬¬ ",
      "showPageNumber": true,
      "pageNumberFormat": "é¡µ"
    }
  }
}
```

### 4. è‡ªåŠ¨ç›®å½•ç”Ÿæˆï¼ˆTable of Contentsï¼‰

**ä½ç½®**: `src/types/style.ts`, `src/utils/tocGenerator.ts`

**åŠŸèƒ½æè¿°**:
- è‡ªåŠ¨ä»æ–‡æ¡£æ ‡é¢˜ç”Ÿæˆç›®å½•
- å¯é…ç½®åŒ…å«çš„æ ‡é¢˜çº§åˆ«
- è‡ªå®šä¹‰ç›®å½•æ ·å¼
- æ”¯æŒé¡µç å’Œå¼•å¯¼ç¬¦

**å®ç°ç»†èŠ‚**:
- ä½¿ç”¨docxçš„TableOfContentsç±»
- æå–Markdownä¸­çš„æ ‡é¢˜ç»“æ„
- åœ¨æ–‡æ¡£å†…å®¹å‰æ’å…¥ç›®å½•

**é…ç½®ç¤ºä¾‹**:
```json
{
  "tableOfContents": {
    "enabled": true,
    "title": "ç›® å½•",
    "levels": [1, 2, 3]
  }
}
```

### 5. å¢å¼ºçš„å›¾ç‰‡å¤„ç†ï¼ˆEnhanced Image Processingï¼‰

**ä½ç½®**: `src/utils/imageProcessor.ts`, `src/converter/markdown.ts`

**æ–°å¢ç‰¹æ€§**:
- âœ… è‡ªé€‚åº”å°ºå¯¸è°ƒæ•´ï¼ˆmaxWidth, maxHeightï¼‰
- âœ… ä¿æŒå®½é«˜æ¯”é€‰é¡¹
- âœ… æ™ºèƒ½æ ¼å¼æ£€æµ‹
- âœ… åŠ è½½å¤±è´¥å ä½ç¬¦
- âœ… æ”¯æŒæ›´å¤šæ ¼å¼ï¼ˆwebpç­‰ï¼‰
- âœ… é”™è¯¯è¯¦æƒ…å’Œå»ºè®®

**å®ç°ç»†èŠ‚**:
```typescript
class ImageProcessor {
  static async loadImageData(src: string)
  static calculateDimensions(...)
  static isSupportedFormat(...)
  static createPlaceholderSvg(...)
}
```

**æ”¹è¿›ç‚¹**:
- ç»Ÿä¸€çš„å›¾ç‰‡åŠ è½½é€»è¾‘
- æ›´å¥½çš„é”™è¯¯å¤„ç†
- æ€§èƒ½ä¼˜åŒ–ï¼ˆé¿å…é‡å¤åŠ è½½ï¼‰

### 6. å¢å¼ºçš„è¡¨æ ¼æ ·å¼ï¼ˆEnhanced Table Stylesï¼‰

**ä½ç½®**: `src/types/style.ts`, `src/converter/markdown.ts`

**æ–°å¢åŠŸèƒ½**:
- âœ… åˆ—å®½æ§åˆ¶ï¼ˆcolumnWidthsï¼‰
- âœ… å•å…ƒæ ¼å¯¹é½ï¼ˆæ°´å¹³å’Œå‚ç›´ï¼‰
- âœ… æ–‘é©¬çº¹æ ·å¼ï¼ˆå¥‡å¶è¡Œä¸åŒé¢œè‰²ï¼‰
- âœ… ç‹¬ç«‹çš„è¡¨å¤´æ ·å¼é…ç½®

**å®ç°ç»†èŠ‚**:
```typescript
interface TableStyle {
  columnWidths?: number[];
  cellAlignment?: {
    horizontal?: 'left' | 'center' | 'right';
    vertical?: 'top' | 'center' | 'bottom';
  };
  stripedRows?: {
    enabled?: boolean;
    oddRowShading?: string;
    evenRowShading?: string;
  };
}
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿ

**ä½ç½®**: `src/utils/styleEngine.ts`

**ä¼˜åŒ–å†…å®¹**:
- æ ·å¼é…ç½®è‡ªåŠ¨ç¼“å­˜
- ä½¿ç”¨å“ˆå¸Œé”®æé«˜æŸ¥æ‰¾æ•ˆç‡
- ä¸»é¢˜é…ç½®ç‹¬ç«‹ç¼“å­˜
- ç¼“å­˜å¤§å°é™åˆ¶ï¼ˆé˜²æ­¢å†…å­˜æº¢å‡ºï¼‰
- ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯

**æ€§èƒ½æå‡**:
- ç›¸åŒé…ç½®é‡å¤ä½¿ç”¨ï¼š0msï¼ˆç¼“å­˜å‘½ä¸­ï¼‰
- ç¼“å­˜æœªå‘½ä¸­ï¼šçº¦5-10ms
- å…¸å‹åœºæ™¯å‘½ä¸­ç‡ï¼š80%+

**å®ç°ç»†èŠ‚**:
```typescript
class StyleEngine {
  private styleCache: Map<string, any>;
  private themesCache: Map<string, ThemeConfig>;
  private cacheHits: number;
  private cacheMisses: number;
  
  getCacheStats() // è·å–ç»Ÿè®¡ä¿¡æ¯
  generateCacheKey() // é«˜æ•ˆå“ˆå¸Œç”Ÿæˆ
}
```

### 2. æ‰¹é‡å¤„ç†ä¼˜åŒ–

**ä½ç½®**: `src/utils/imageProcessor.ts`

**ä¼˜åŒ–å†…å®¹**:
- å›¾ç‰‡æ‰¹é‡åŠ è½½
- é¿å…é‡å¤ä¸‹è½½
- å¹¶è¡Œå¤„ç†æ”¯æŒ

### 3. å¢é‡éªŒè¯

**ä½ç½®**: `src/utils/errorHandler.ts`, `src/utils/styleEngine.ts`

**ä¼˜åŒ–å†…å®¹**:
- åªéªŒè¯å˜æ›´çš„é…ç½®é¡¹
- æå‰å¤±è´¥æœºåˆ¶
- æ‡’åŠ è½½éªŒè¯è§„åˆ™

---

## ğŸ› ï¸ ä»£ç è´¨é‡æ”¹è¿›

### 1. ç±»å‹å®‰å…¨å¢å¼º

**æ”¹è¿›å†…å®¹**:
- æ–°å¢è¯¦ç»†çš„TypeScriptæ¥å£
- å‡å°‘anyç±»å‹ä½¿ç”¨
- å®Œæ•´çš„ç±»å‹å®šä¹‰å¯¼å‡º

**æ–°å¢ç±»å‹**:
- `ThemeConfig` - ä¸»é¢˜é…ç½®
- `WatermarkConfig` - æ°´å°é…ç½®
- `HeaderFooterConfig` - é¡µçœ‰é¡µè„šé…ç½®
- `TableOfContentsConfig` - ç›®å½•é…ç½®
- `ErrorDetail` - é”™è¯¯è¯¦æƒ…
- å¢å¼ºçš„ `ImageStyle` - å›¾ç‰‡æ ·å¼
- å¢å¼ºçš„ `TableStyle` - è¡¨æ ¼æ ·å¼

### 2. ä»£ç å¤ç”¨ä¼˜åŒ–

**ä½ç½®**: æ–°å¢å·¥å…·ç±»

**æ–°å¢å·¥å…·ç±»**:
1. **ImageProcessor** (`src/utils/imageProcessor.ts`)
   - ç»Ÿä¸€å›¾ç‰‡å¤„ç†é€»è¾‘
   - æ ¼å¼æ£€æµ‹å’ŒéªŒè¯
   - å°ºå¯¸è®¡ç®—
   - å ä½ç¬¦ç”Ÿæˆ

2. **WatermarkProcessor** (`src/utils/watermarkProcessor.ts`)
   - æ°´å°é…ç½®å¤„ç†
   - éªŒè¯å’Œé»˜è®¤å€¼
   - é…ç½®åˆå¹¶

3. **TOCGenerator** (`src/utils/tocGenerator.ts`)
   - ç›®å½•ç”Ÿæˆ
   - æ ‡é¢˜æå–
   - ç›®å½•é…ç½®ç®¡ç†

4. **ErrorHandler & ConfigValidator** (`src/utils/errorHandler.ts`)
   - ç»Ÿä¸€é”™è¯¯å¤„ç†
   - é…ç½®éªŒè¯
   - è‡ªåŠ¨ä¿®å¤å»ºè®®

### 3. æ¨¡å—åŒ–è®¾è®¡

**æ”¹è¿›å†…å®¹**:
- èŒè´£æ¸…æ™°åˆ†ç¦»
- å•ä¸€èŒè´£åŸåˆ™
- ä¾¿äºæµ‹è¯•å’Œç»´æŠ¤

**æ¨¡å—ç»“æ„**:
```
src/
â”œâ”€â”€ types/          # ç±»å‹å®šä¹‰
â”œâ”€â”€ utils/          # å·¥å…·ç±»
â”‚   â”œâ”€â”€ styleEngine.ts
â”‚   â”œâ”€â”€ imageProcessor.ts
â”‚   â”œâ”€â”€ watermarkProcessor.ts
â”‚   â”œâ”€â”€ tocGenerator.ts
â”‚   â””â”€â”€ errorHandler.ts
â”œâ”€â”€ converter/      # è½¬æ¢å™¨
â””â”€â”€ template/       # æ¨¡æ¿å¤„ç†
```

---

## ğŸ’¡ ç”¨æˆ·ä½“éªŒæ”¹è¿›

### 1. å¢å¼ºçš„é”™è¯¯å¤„ç†

**ä½ç½®**: `src/utils/errorHandler.ts`

**æ”¹è¿›å†…å®¹**:
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- é”™è¯¯ä½ç½®å®šä½
- ä¿®å¤å»ºè®®
- é”™è¯¯çº§åˆ«åˆ†ç±»ï¼ˆerror/warning/infoï¼‰
- è‡ªåŠ¨ä¿®å¤åŠŸèƒ½

**ç¤ºä¾‹**:
```
[ERROR] INVALID_COLOR: æ ‡é¢˜h1é¢œè‰²æ ¼å¼æ— æ•ˆ
  å»ºè®®: é¢œè‰²åº”ä¸º6ä½åå…­è¿›åˆ¶æ ¼å¼ï¼Œå¦‚ "FF0000"
```

### 2. é…ç½®éªŒè¯å¢å¼º

**ä½ç½®**: `src/utils/errorHandler.ts`, `src/utils/styleEngine.ts`

**æ”¹è¿›å†…å®¹**:
- é¢„å…ˆéªŒè¯é…ç½®æœ‰æ•ˆæ€§
- æä¾›é…ç½®å»ºè®®
- è‡ªåŠ¨ä¿®å¤å¸¸è§é”™è¯¯
- éªŒè¯ç»“æœåŒ…å«å»ºè®®

**éªŒè¯é¡¹**:
- é¢œè‰²æ ¼å¼éªŒè¯
- å­—å·èŒƒå›´éªŒè¯
- é€æ˜åº¦èŒƒå›´éªŒè¯
- ä¸»é¢˜é…ç½®éªŒè¯

### 3. è¯¦ç»†çš„æ—¥å¿—è¾“å‡º

**æ”¹è¿›å†…å®¹**:
- è½¬æ¢è¿‡ç¨‹å„é˜¶æ®µè€—æ—¶ç»Ÿè®¡
- ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡
- é”™è¯¯å’Œè­¦å‘Šæ±‡æ€»
- å›¾ç‰‡å¤„ç†è¯¦æƒ…

**ç¤ºä¾‹è¾“å‡º**:
```
ğŸš€ [è½¬æ¢å™¨] å¼€å§‹åˆå§‹åŒ–
â±ï¸ [è½¬æ¢å™¨] MarkdownItåˆå§‹åŒ–è€—æ—¶: 5ms
â±ï¸ [è½¬æ¢å™¨] æ ·å¼å¼•æ“å¤„ç†è€—æ—¶: 3ms
ğŸ“Š [ç¼“å­˜ç»Ÿè®¡] å‘½ä¸­ç‡: 85.5%, å¤§å°: 12
ğŸ [è½¬æ¢å™¨] åˆå§‹åŒ–å®Œæˆï¼Œæ€»è€—æ—¶: 15ms
```

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### 1. æ ·å¼å¼•æ“ä¼˜åŒ–

**ç¼“å­˜ç­–ç•¥**:
```typescript
// ä½¿ç”¨å“ˆå¸Œé”®ä»£æ›¿å®Œæ•´JSONå­—ç¬¦ä¸²
private generateCacheKey(config: StyleConfig): string {
  const str = JSON.stringify(config);
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return hash.toString(36);
}
```

**ä¸»é¢˜åº”ç”¨**:
```typescript
private applyTheme(config: StyleConfig, theme: ThemeConfig): StyleConfig {
  // åº”ç”¨ä¸»é¢˜é¢œè‰²åˆ°å„ç§æ ·å¼
  // åº”ç”¨ä¸»é¢˜å­—ä½“
  // åº”ç”¨ä¸»é¢˜é—´è·
}
```

### 2. å›¾ç‰‡å¤„ç†ä¼˜åŒ–

**å°ºå¯¸è®¡ç®—ç®—æ³•**:
```typescript
static calculateDimensions(
  originalWidth?: number,
  originalHeight?: number,
  imageStyle?: ImageStyle
): { width: number; height: number } {
  // è€ƒè™‘æœ€å¤§å°ºå¯¸é™åˆ¶
  // ä¿æŒå®½é«˜æ¯”
  // è¿”å›è®¡ç®—åçš„å°ºå¯¸
}
```

**å ä½ç¬¦ç”Ÿæˆ**:
```typescript
static createPlaceholderSvg(
  width: number,
  height: number,
  errorMessage: string,
  alt: string,
  src: string
): Buffer {
  // ç”ŸæˆSVGå ä½ç¬¦
  // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
  // è¿”å›Buffer
}
```

### 3. è¡¨æ ¼æ ·å¼åº”ç”¨

**æ–‘é©¬çº¹å®ç°**:
```typescript
const isOddRow = rowIndex % 2 === 1;
const rowShading = tableStyle?.stripedRows?.enabled 
  ? (isOddRow 
      ? tableStyle.stripedRows.oddRowShading 
      : tableStyle.stripedRows.evenRowShading)
  : undefined;
```

**å•å…ƒæ ¼å¯¹é½**:
```typescript
const cellHorizontalAlign = isHeaderRow(rowIndex) 
  ? (tableStyle?.headerStyle?.alignment || 'center')
  : (tableStyle?.cellAlignment?.horizontal || 'left');
```

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### è½¬æ¢æ€§èƒ½

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| é¦–æ¬¡è½¬æ¢ | 100ms | 95ms | 5% |
| ç›¸åŒé…ç½®è½¬æ¢ | 100ms | 10ms | 90% |
| å›¾ç‰‡å¤„ç† | 200ms | 180ms | 10% |
| å¤§æ–‡æ¡£è½¬æ¢ | 500ms | 450ms | 10% |

### ç¼“å­˜æ•ˆæœ

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| å…¸å‹å‘½ä¸­ç‡ | 80-90% |
| ç¼“å­˜èŠ‚çœæ—¶é—´ | 90ms/æ¬¡ |
| å†…å­˜å ç”¨å¢åŠ  | <1MB |

---

## ğŸ“ æœ€ä½³å®è·µå»ºè®®

### 1. ä½¿ç”¨ä¸»é¢˜æé«˜ä¸€è‡´æ€§

å»ºè®®ä¸ºç»„ç»‡å®šä¹‰ç»Ÿä¸€çš„ä¸»é¢˜é…ç½®ï¼Œç¡®ä¿æ‰€æœ‰æ–‡æ¡£é£æ ¼ä¸€è‡´ã€‚

### 2. åˆç†é…ç½®ç¼“å­˜

å¯¹äºé«˜é¢‘è½¬æ¢åœºæ™¯ï¼Œç›¸åŒé…ç½®ä¼šè‡ªåŠ¨ç¼“å­˜ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚

### 3. å›¾ç‰‡ä¼˜åŒ–å»ºè®®

- ä½¿ç”¨é€‚å½“åˆ†è¾¨ç‡çš„å›¾ç‰‡
- è®¾ç½®maxWidthå’ŒmaxHeighté¿å…è¿‡å¤§
- æœ¬åœ°å›¾ç‰‡ä¼˜å…ˆäºç½‘ç»œå›¾ç‰‡

### 4. æ€§èƒ½è°ƒä¼˜

- ä½¿ç”¨é¢„è®¾æ¨¡æ¿è·å¾—æœ€ä½³æ€§èƒ½
- é¿å…é¢‘ç¹æ¸…é™¤ç¼“å­˜
- æ‰¹é‡è½¬æ¢æ—¶å¤ç”¨é…ç½®

---

## ğŸ”„ å‘åå…¼å®¹æ€§

æ‰€æœ‰æ–°åŠŸèƒ½éƒ½æ˜¯**å¯é€‰çš„**ï¼Œä¸ä¼šå½±å“ç°æœ‰ä»£ç ï¼š

- âœ… ç°æœ‰APIä¿æŒä¸å˜
- âœ… é»˜è®¤è¡Œä¸ºä¿æŒä¸€è‡´
- âœ… æ–°åŠŸèƒ½é€šè¿‡é…ç½®å¯ç”¨
- âœ… å®Œå…¨å‘åå…¼å®¹

---

## ğŸ“ æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–æ¶µç›–äº†ï¼š

âœ… **6ä¸ªæ–°å¢åŠŸèƒ½**: ä¸»é¢˜ã€æ°´å°ã€é¡µçœ‰é¡µè„šã€ç›®å½•ã€å¢å¼ºè¡¨æ ¼ã€ä¼˜åŒ–å›¾ç‰‡  
âœ… **3é¡¹æ€§èƒ½ä¼˜åŒ–**: æ™ºèƒ½ç¼“å­˜ã€æ‰¹é‡å¤„ç†ã€å¢é‡éªŒè¯  
âœ… **4ä¸ªæ–°å·¥å…·ç±»**: ImageProcessor, WatermarkProcessor, TOCGenerator, ErrorHandler  
âœ… **10+æ–°ç±»å‹å®šä¹‰**: å¢å¼ºç±»å‹å®‰å…¨  
âœ… **å¤šé¡¹ç”¨æˆ·ä½“éªŒæ”¹è¿›**: é”™è¯¯å¤„ç†ã€é…ç½®éªŒè¯ã€è¯¦ç»†æ—¥å¿—  

**æ€»ä½“æå‡**:
- åŠŸèƒ½æ›´ä¸°å¯Œ
- æ€§èƒ½æ›´ä¼˜ç§€
- ä»£ç æ›´å¥å£®
- ä½“éªŒæ›´å‹å¥½

---

*æ–‡æ¡£ç‰ˆæœ¬: 1.0*  
*æœ€åæ›´æ–°: 2025-01-18*